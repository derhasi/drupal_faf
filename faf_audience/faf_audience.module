<?php

/**
 * @file
 *   This module provides an API to define a audience via audience types.
 *   This information will be used by faf to define access groups.
 */

/**
 * Implementation of hook_perm().
 */
function faf_audience_perm() {
  return array('administer faf_audience');
}

/**
 * Wrapper function for loading types via ctools plugin.
 */
function faf_audience_get_types() {
  ctools_include('plugins');
  return ctools_get_plugins('faf_audience', 'audience_types');
}

/**
 * Wrapper function for loading a single audience type, using ctools plugin.
 */
function faf_audience_get_type($audience_type) {
  ctools_include('plugins');
  return ctools_get_plugins('faf_audience', 'audience_types', $audience_type);
}

/**
 * Check if the given user is member of the given audience preset
 *
 * @param $preset_name
 *   string identifier of the audience preset to check on
 * @param $account
 *   user object of the user to check on
 *   defaults to NULL so the current user will be used.
 * @param $context
 *   additional entities "member of" function can validate the user with, for
 *   example array('node' => $node) to check on a given node, like in node
 *   author/editor or userreference field.
 *
 * @return
 *   TRUE if the user is member of the given audience preset in the given context
 *   FALSE if not
 */
function faf_audience_is_member_of($preset_name, $account = NULL, $context = array()) {
  if (!isset($account)) {
    GLOBAL $user;
    $account = $user;
  }

  // Load preset
  $preset = ctools_export_crud_load('faf_audience_preset', $preset_name);
  // Get callback for the presets audience type.
  $is_member_of_callback = ctools_plugin_load_function('faf_audience', 'audience_types', $preset->audience_type, 'is member callback');
  // Check on callback, if it exists.
  if ($is_member_of_callback) {
    return $is_member_of_callback($preset, $account, $context);
  }
  // Else return FALSE, as no callback could be found.
  return FALSE;
}


/**
 * Helper function to retrieve options as keyed array from plugin definitions.
 */
function faf_audience_types_options_array($option) {
  $plugins = faf_audience_get_types();
  $return = array();
  foreach ($plugins as $name => $plugin) {
    if (isset($plugin[$option])) {
      $return[$name] = $plugin[$option];
    }
  }
  return $return;
}

/**
 * Implementation of pseudohook_ctools_plugin_PLUGINTYPE().
 *
 * Inform CTools about default values for the plugin implementation.
 */
function faf_audience_ctools_plugin_audience_types() {
  return array(
    'defaults' => array(
      // A callback function
      'is member callback' => NULL,
      // Selector options (either array or callback)
      'selector options' => NULL,
      'selector title' => 'Selector',
      'selector description' => 'Configure the given audience type by selecting an option.',
      // @TODO: maybe additional config form
      // 'config form' => '',
    ),
    //'process' => '_faf_audience_ctools_plugin_process',
  );
}

/**
 * Implement hook_ctools_plugin_directory().
 *
 * So we can define some data for different plugins, as faf_audience_types.
 */
function faf_audience_ctools_plugin_directory($module, $plugin) {
  // FAF Audience Types
  if ($module == 'faf_audience' && $plugin == 'audience_types') {
    return 'plugins/audience_types';
  }
  // Load the export_ui plugin for implementing faf_audience settings page.
  elseif ($plugin =='export_ui') {
    return 'plugins/export_ui';
  }
}

//----- Audience (Exportables) ----//

/**
 * Implementation of hook_ctools_plugin_api().
 *
 * Tell CTools that we support the default_faf_audience API.
 */
function faf_audience_ctools_plugin_api($owner, $api) {
  if ($owner == 'faf_audience' && $api == 'default_faf_audience_preset') {
    return array('version' => 1);
  }
}

/**
 * Implementation of hook_default_faf_audience_preset().
 *
 * Provide a couple of default audience presets.
 */
function faf_audience_default_faf_audience_preset() {
  $export = array();

  // Super User ($user->uid == 1)
  $preset = new stdClass;
  $preset->api_version = 1;
  $preset->name = 'user_1';
  $preset->description = 'Super user';
  $preset->audience_type = 'user';
  $preset->selector = '1';
  $preset->config = NULL;
  $export['user_1'] = $preset;

  // Anonymous user
  $preset = new stdClass;
  $preset->api_version = 1;
  $preset->name = 'anonymous_user';
  $preset->description = 'anonymous user';
  $preset->audience_type = 'roles';
  $preset->selector = '1';
  $preset->config = NULL;
  $export['anonymous_user'] = $preset;

  // Authenticated user
  $preset = new stdClass;
  $preset->api_version = 1;
  $preset->name = 'authenticated_user';
  $preset->description = 'authenticated user';
  $preset->audience_type = 'roles';
  $preset->selector = '2';
  $preset->config = NULL;
  $export['authenticated_user'] = $preset;

  return $export;
}
